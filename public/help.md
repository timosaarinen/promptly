# Promptly User Guide

Welcome to Promptly! This guide will help you understand how to use Promptly effectively to craft precise, context-aware prompts for Large Language Models (LLMs) and manage their responses.

## 1. Core Concepts

Promptly is designed around a core workflow:

1.  **Select Context**: Choose files and folders from your project to provide relevant background to the LLM.
2.  **Compose Prompt**: Write your instructions for the LLM, selecting a mode that best suits your task.
3.  **Generate & Use**: Copy the fully assembled prompt (system instructions + your context + your custom prompt) and paste it into your preferred LLM interface.
4.  **Apply Changes**: Paste the LLM's XML response back into Promptly to review and apply suggested file modifications.

## 2. Getting Started: The Interface

### 2.1. Left Panel: Context Building

*   **Root Folder Selection**:
    *   Promptly needs a root folder for your project. Click "Select Root Folder" or "Change" in the header of the Left Panel.
    *   This defines the base for all relative file paths used in context and operations.
    *   **Respect .gitignore Rules**: Toggle this option to control whether files listed in your project's `.gitignore` file (and standard ignores like `node_modules`) are excluded from the File Explorer and context. This is enabled by default.
*   **File Explorer**:
    *   Displays the file and directory structure of your selected root folder.
    *   Click the checkbox next to a file or folder to select/deselect it for inclusion in the LLM context.
        *   **Full Selection (CheckSquare icon)**: The entire content of the file is included.
        *   **Ignored (Square icon)**: The file/folder is not included.
        *   **Indeterminate (MinusSquare icon)**: For directories, indicates that some children are selected and some are not.
    *   Binary files or files larger than 100KB are automatically unselectable (XSquare icon) and will not be included in the context.
    *   Clicking a directory name will expand/collapse it.
    *   Aggregate size and estimated token counts for selected items within directories are shown when the directory is collapsed.
*   **Git Status Panel**:
    *   If your root folder is a Git repository, this panel shows the current branch, commit hash, and a list of changed files.
    *   **Add diff to context**: If checked, the combined diff of uncommitted changes will be included in the `<git_diff>` section of the context XML. This is useful for asking the LLM to review or act upon recent modifications.
    *   **Commit Button (Send Icon)**: Appears if there are changes. Clicking this opens the Commit Panel in the Right Panel area, pre-filling with affected files.

### 2.2. Right Panel: Prompting & Applying

The Right Panel has three main modes, selectable via buttons at the top:

*   **Compose Prompt**: For creating new prompts.
*   **Apply LLM Response**: For pasting and processing responses from an LLM.
*   **Commit View**: For staging, committing, and pushing Git changes (typically accessed via the Git Status Panel or after applying LLM changes).

#### 2.2.1. Compose Prompt Mode

*   **Context Summary**: Displays the status of the XML context being built from your selected files.
    *   Shows number of files selected and total token count.
    *   Right-click this area for options to "Save Context XML..." or "Copy Context XML Only".
*   **Prompt Mode Dropdown**: Select the system prompt to guide the LLM's behavior:
    *   **Architect Mode**: Instructs the LLM to first create a plan (`<plan>` tag) and then provide file changes. Ideal for complex tasks, refactoring, or new feature design.
    *   **Ask Mode**: For general questions about the codebase. The LLM is instructed *not* to output XML but to answer in plain text/markdown. Useful for understanding code, summarization, or getting explanations.
    *   **Edit Mode**: Instructs the LLM to directly output file changes without a separate planning phase. Suitable for more straightforward edits or fixes.
*   **Prompt Input Area**:
    *   Type your specific instructions for the LLM here.
    *   Use Shift+Enter for newlines. Enter alone will attempt to send the prompt.
*   **Send Button (Paper Airplane Icon)**:
    *   Assembles the final prompt: (System Primer + Selected Prompt Mode Instructions + Context XML + Your Custom Prompt).
    *   Copies this entire assembled prompt to your clipboard.
    *   You then paste this into your chosen LLM chat interface.

#### 2.2.2. Apply LLM Response Mode

This mode is for processing responses you receive from an LLM after sending it a prompt generated by Promptly (especially when using Architect or Edit modes).

*   **LLM Response Input Area**:
    *   Paste the *entire* XML response from your LLM here. Promptly expects a response wrapped in `<response>...</response>` tags.
    *   Click "Process Response".
*   **Response Blocks**:
    *   Each processed response appears as a collapsible block.
    *   **Header**: Shows response number, a summary of parsed changes (e.g., "3 File Ops â€¢ 1 Message"), and the overall application status ("Pending", "All Applied", "Parse Error", etc.). Click to expand/collapse.
    *   **Expanded View**:
        *   Displays `<plan>` content (if any) as markdown.
        *   Lists each proposed change (`<file-write>`, `<file-replace-block>`, `<file-delete>`, `<message>`).
        *   **File Operations**:
            *   Shows the file path and the reason for the change.
            *   For `<file-write>` (Create): Shows a diff of the new content against an empty file.
            *   For `<file-replace-block>` (Edit): Shows a color-coded diff of the changes.
            *   **Validation**: Promptly checks if files to be edited or deleted exist. If a file is missing for an edit/delete, a warning appears with options to "Skip" or "Force Apply".
            *   **Copy Icon**: Allows copying the raw content (for `file-write`) or diff content (for `file-replace-block`).
        *   **Messages**: Displays messages from the LLM (e.g., commit messages, general notes).
        *   **Apply Valid Changes from This Response Button**: Attempts to apply all changes in the current block that are in a valid state (e.g., "Validation Success").
*   **Adding Follow-Up Responses**:
    *   After processing one response, click "Add LLM Response" to paste and process a subsequent response from the LLM (e.g., if you asked it for corrections).
*   **Clear All Button**: Removes all processed response blocks.

#### 2.2.3. Commit View Mode

*   Accessed programmatically (e.g., after applying changes that affect files, or by clicking the commit button in the Git Status Panel).
*   **Affected Files**: Lists files that will be part of the commit (based on applied changes or all current Git changes).
*   **Commit Message**: Pre-filled if the LLM provided one via a `<message purpose="commit">` tag, or with a generic message. You can edit this.
*   **Actions**:
    *   **Commit**: Stages all current changes and commits them with the provided message.
    *   **Stage All Changes**: Equivalent to `git add .`.
    *   **Commit & Push**: Commits and then attempts to push to the remote repository.
    *   **Cancel/Done**: Closes the commit panel and returns to a previous view.

## 3. Understanding the XML Context and Response Format

Promptly uses XML for structuring context sent to LLMs and for parsing responses proposing file changes.

### 3.1. Context Sent to LLM (Simplified Structure)

```xml
<context version="0.2.0" timestamp="..." generated_by="Promptly">
  <summary>
    <purpose>Contextual project contents</purpose>
    <!-- Other metadata -->
    <git_commit_hash>...</git_commit_hash> <!-- If applicable -->
  </summary>
  <directory_structure>
    path/to/file.ts
    another/path/
    another/path/component.tsx
  </directory_structure>
  <files>
    <file path="path/to/file.ts">
      // Content of file.ts
    </file>
    <file path="another/path/component.tsx">
      // Content of component.tsx
    </file>
  </files>
  <git_diff> <!-- If "Add diff to context" is checked and diff exists -->
    --- a/some/file.js
    +++ b/some/file.js
    @@ -1,3 +1,3 @@
    -old line
    +new line
  </git_diff>
</context>
```

### 3.2. Response Expected from LLM (Key Tags)

Your LLM should respond with an XML block. Key tags Promptly understands:

*   `<response>`: The root tag for all changes.
*   `<context-timestamp>`: LLM should echo back the timestamp from the input context.
*   `<plan>`: Markdown content describing the LLM's proposed plan.
*   `<file-write path="path/to/new_file.js" reason="Why this file is created">`: Contains the full content for a new file.
*   `<file-replace-block path="path/to/existing_file.ts" reason="Why this change is made">`: Contains a diff in a specific search-replace format:
    ```xml
    <<<<<<< SEARCH
    Exact lines to find in the original file.
    Must be a perfect match, including whitespace and line endings.
    =======
    New lines to replace the SEARCH block.
    >>>>>>> REPLACE
    ```
*   `<file-delete path="path/to/obsolete_file.css" reason="Why this file is deleted" />`: Self-closing tag to indicate file deletion.
*   `<message purpose="commit">A conventional commit message.</message>`: A message, often used for Git commit messages.
*   `<message>Any other note or comment from the LLM.</message>`

**Important for LLM Output:**
*   The LLM should provide raw code content within file operation tags, NOT wrapped in CDATA and NOT XML-escaped by the LLM.
*   The `<<<<<<< SEARCH` block in `<file-replace-block>` must be an *exact* match of existing content.

## 4. Tips for Effective Use

*   **Focused Context**: Select only the files truly relevant to your current task. Smaller contexts are faster for LLMs to process and can lead to more accurate results.
*   **Iterate in Small Steps**: For complex features, break down the task. Ask the LLM for a plan first (Architect Mode), then for specific implementations or changes.
*   **Follow-Up Prompts**: If the LLM's first response isn't perfect, paste any error messages (lint, type-check, runtime) or describe the issue and ask for a correction. Add the LLM's new response to the "Apply LLM Response" panel.
*   **Start Fresh After Commits**: Once you've successfully applied changes and committed them, consider clearing the "Apply LLM Response" panel and starting a new "Compose Prompt" cycle. This keeps the LLM's understanding aligned with your latest codebase state.
*   **Review Carefully**: Always review the diffs and file changes proposed by the LLM in the "Apply LLM Response" panel before applying them.
*   **Use `Ask Mode` Liberally**: For understanding code, discussing approaches, or getting summaries, `Ask Mode` is efficient as it doesn't require XML parsing on Promptly's side.

## 5. Troubleshooting & FAQ

*   **"Context is empty" or "No context files selected" in Prompt Panel**:
    *   Ensure you have selected files in the File Explorer.
    *   Check if the selected files are very small, binary, or marked as unselectable (e.g., over 100KB).
    *   If "Respect .gitignore rules" is on, your files might be ignored.
*   **"Parse Error" in Apply Panel for an LLM Response**:
    *   The LLM's response might not be valid XML or might not conform to the expected tag structure (e.g., missing `</response>`, malformed `<file-replace-block>` block).
    *   Try to identify the malformed part in the LLM's raw output and ask the LLM to correct its XML structure.
*   **Token Counts Seem High/Low**:
    *   Promptly uses `tiktoken` (via `gpt-tokenizer`) for token estimation, which is generally accurate for OpenAI models.
    *   The "Context Tokens" count in the Prompt Panel reflects the tokens for the assembled XML context *before* your custom prompt and system instructions are added. The Status Bar shows a combined total.
*   **File Changes Not Applying Correctly**:
    *   For `<file-replace-block>` operations, the `<<<<<<< SEARCH` block must *exactly* match a segment of your current local file. If the local file has changed since the context was generated, the diff may fail to apply. Promptly attempts to detect this via context timestamp/hash but manual review is key.
    *   Ensure your LLM is not attempting to use XML escaping (like `&lt;` for `<`) within the code blocks it generates.

## 6. Keyboard Shortcuts

Promptly supports a range of keyboard shortcuts to enhance productivity. (Use `Cmd` instead of `Ctrl` on macOS).

**Key Global Shortcuts:**
*   **`Ctrl+B`**: Toggle Left Panel visibility.
*   **`Ctrl+1`**: Focus File Explorer.
*   **`Ctrl+2`**: Jump to 'Compose' panel and focus prompt input.
*   **`Ctrl+3`**: Jump to 'Apply' panel.
*   **`Ctrl+4`**: Jump to 'Test' panel and run current test command.
*   **`Ctrl+5`**: Jump to 'Post-Process' panel.
*   **`Ctrl+6`**: Jump to 'Commit' panel.
*   **`Ctrl+Alt+[1-4]`**: Switch Prompt Mode (Architect, Ask, Edit, ContextBuilder).
*   **`Ctrl+Shift+V`**: Paste and process LLM response in 'Apply' panel.
*   **`Ctrl+Shift+C`**: Copy full prompt from 'Compose' panel.
*   **`Ctrl+Shift+O`**: Copy LLM XML output format instructions.

**File Explorer Specific:**
*   **Arrow Keys**: Navigate.
*   **`SPACE`**: Toggle selection.
*   **`1-5`**: Set selection state/importance.
*   **`ENTER`**: View file.
*   **`TAB`**: Jump to prompt input.

**Prompt Input Specific:**
*   **`ENTER` / `Ctrl+ENTER`**: Send prompt.
*   **`Shift+ENTER`**: Newline.

---

We hope this guide helps you make the most of Promptly. Happy prompting!